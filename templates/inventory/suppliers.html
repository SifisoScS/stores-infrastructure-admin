{% extends "base.html" %}

{% block title %}Suppliers & Contractors - Derivco Stores Administration{% endblock %}

{% block content %}
<div class="suppliers-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="/">Dashboard</a>
            <span class="separator">/</span>
            <span class="current">Suppliers & Contractors</span>
        </div>
        <h2><i class="fas fa-truck"></i> Suppliers & Contractors</h2>
        <p class="subtitle">Manage supplier relationships and contractor information</p>
    </div>

    <div class="suppliers-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <h3>{{ suppliers|length }}</h3>
                <p>Total Suppliers</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon active">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
                <h3 id="preferred-count">0</h3>
                <p>Preferred Vendors</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h3 id="expiring-contracts">0</h3>
                <p>Contracts Expiring Soon</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-th-list"></i>
            </div>
            <div class="stat-content">
                <h3 id="categories-count">0</h3>
                <p>Categories Covered</p>
            </div>
        </div>
    </div>

    <div class="actions-bar">
        <div class="search-and-filter">
            <div class="search-box">
                <input type="text" id="supplier-search" placeholder="Search suppliers...">
                <i class="fas fa-search"></i>
            </div>
            
            <select id="category-filter" class="filter-select">
                <option value="">All Categories</option>
                <option value="Electric">Electric</option>
                <option value="Plumbing">Plumbing</option>
                <option value="Carpentry">Carpentry</option>
                <option value="Painting">Painting</option>
                <option value="Aircon">Aircon</option>
                <option value="General">General</option>
            </select>
            
            <select id="status-filter" class="filter-select">
                <option value="">All Status</option>
                <option value="Preferred">Preferred</option>
                <option value="Approved">Approved</option>
                <option value="Standard">Standard</option>
            </select>
        </div>
        
        <div class="action-buttons">
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i> Print Directory
            </button>
            <button onclick="exportSuppliersData()" class="btn btn-info">
                <i class="fas fa-download"></i> Export CSV
            </button>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    {% if suppliers %}
    <div class="suppliers-grid" id="suppliers-container">
        {% for supplier in suppliers %}
        <div class="supplier-card" data-supplier-name="{{ supplier.get('Supplier Name', '').lower() }}" 
             data-category="{{ supplier.get('Category Supplied', '').lower() }}"
             data-status="{{ supplier.get('Preferred / Approved Vendor Indicator', '').lower() }}">
            
            <div class="supplier-header">
                <h4><i class="fas fa-building"></i> {{ supplier.get('Supplier Name', 'Unknown Supplier') }}</h4>
                <span class="vendor-badge {{ 'preferred' if 'preferred' in supplier.get('Preferred / Approved Vendor Indicator', '').lower() else 'approved' if 'approved' in supplier.get('Preferred / Approved Vendor Indicator', '').lower() else 'standard' }}">
                    {{ supplier.get('Preferred / Approved Vendor Indicator', 'Standard') }}
                </span>
            </div>
            
            <div class="supplier-info">
                <div class="info-item">
                    <i class="fas fa-tags"></i>
                    <span class="label">Category:</span>
                    <span class="value">{{ supplier.get('Category Supplied', 'N/A') }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-user"></i>
                    <span class="label">Contact Person:</span>
                    <span class="value">{{ supplier.get('Contact Person', 'N/A') }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <span class="label">Contact:</span>
                    <span class="value">{{ supplier.get('Phone/Email', 'N/A') }}</span>
                </div>
                
                {% if supplier.get('Contract Expiry Date') %}
                <div class="info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="label">Contract Expires:</span>
                    <span class="value contract-expiry" data-expiry="{{ supplier.get('Contract Expiry Date') }}">
                        {{ supplier.get('Contract Expiry Date') }}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="supplier-actions">
                <button onclick="contactSupplier('{{ supplier.get('Supplier Name', '') }}', '{{ supplier.get('Phone/Email', '') }}')" 
                        class="btn btn-primary btn-sm">
                    <i class="fas fa-phone"></i> Contact
                </button>
                <button onclick="viewSupplierDetails('{{ supplier.get('Supplier Name', '') }}')" 
                        class="btn btn-info btn-sm">
                    <i class="fas fa-eye"></i> Details
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="no-data">
        <div class="no-data-content">
            <i class="fas fa-truck"></i>
            <h3>No Suppliers Found</h3>
            <p>No supplier information is available in the system.</p>
            <p>Add supplier data to the Excel spreadsheet and reload the data.</p>
            <div class="no-data-actions">
                <button onclick="reloadData()" class="btn btn-info">
                    <i class="fas fa-sync-alt"></i> Reload Data
                </button>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Supplier Details Modal -->
<div id="supplierDetailsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-building"></i> Supplier Details</h3>
            <span class="close" onclick="closeModal('supplierDetailsModal')">&times;</span>
        </div>
        <div class="modal-body" id="supplierDetailsBody">
            <!-- Supplier details will be loaded here -->
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div id="contactModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-phone"></i> Contact Supplier</h3>
            <span class="close" onclick="closeModal('contactModal')">&times;</span>
        </div>
        <div class="modal-body" id="contactModalBody">
            <!-- Contact information will be loaded here -->
        </div>
    </div>
</div>

<!-- Contract Expiry Alert -->
<div id="expiryAlert" class="alert-banner" style="display: none;">
    <div class="alert-content">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="expiry-message"></span>
        <button class="alert-close" onclick="closeAlert()">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    calculateStats();
    checkContractExpiries();
    setupFilters();
});

// Calculate and display statistics
function calculateStats() {
    const suppliers = document.querySelectorAll('.supplier-card');
    let preferredCount = 0;
    let categoriesSet = new Set();
    
    suppliers.forEach(card => {
        // Count preferred vendors
        if (card.querySelector('.vendor-badge.preferred')) {
            preferredCount++;
        }
        
        // Count unique categories
        const category = card.querySelector('.info-item .value').textContent.trim();
        if (category !== 'N/A') {
            categoriesSet.add(category);
        }
    });
    
    // Update display
    document.getElementById('preferred-count').textContent = preferredCount;
    document.getElementById('categories-count').textContent = categoriesSet.size;
}

// Check for contract expiries
function checkContractExpiries() {
    const expiryElements = document.querySelectorAll('.contract-expiry');
    const today = new Date();
    const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
    let expiringCount = 0;
    let soonestExpiry = null;
    
    expiryElements.forEach(element => {
        const expiryDate = new Date(element.dataset.expiry);
        
        if (expiryDate <= thirtyDaysFromNow && expiryDate >= today) {
            expiringCount++;
            element.classList.add('expiring-soon');
            
            if (!soonestExpiry || expiryDate < soonestExpiry) {
                soonestExpiry = expiryDate;
            }
        } else if (expiryDate < today) {
            element.classList.add('expired');
        }
    });
    
    // Update expiring contracts count
    document.getElementById('expiring-contracts').textContent = expiringCount;
    
    // Show alert if contracts are expiring soon
    if (expiringCount > 0) {
        showExpiryAlert(expiringCount, soonestExpiry);
    }
}

// Show contract expiry alert
function showExpiryAlert(count, soonestDate) {
    const alert = document.getElementById('expiryAlert');
    const message = document.getElementById('expiry-message');
    const dateStr = soonestDate.toLocaleDateString();
    
    message.textContent = `${count} contract${count > 1 ? 's' : ''} expiring within 30 days. Earliest: ${dateStr}`;
    alert.style.display = 'block';
}

// Close alert
function closeAlert() {
    document.getElementById('expiryAlert').style.display = 'none';
}

// Setup filter functionality
function setupFilters() {
    const searchInput = document.getElementById('supplier-search');
    const categoryFilter = document.getElementById('category-filter');
    const statusFilter = document.getElementById('status-filter');
    const supplierCards = document.querySelectorAll('.supplier-card');
    
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value.toLowerCase();
        const selectedStatus = statusFilter.value.toLowerCase();
        
        supplierCards.forEach(card => {
            const supplierName = card.dataset.supplierName;
            const category = card.dataset.category;
            const status = card.dataset.status;
            
            let showCard = true;
            
            // Search filter
            if (searchTerm && !supplierName.includes(searchTerm)) {
                showCard = false;
            }
            
            // Category filter
            if (selectedCategory && !category.includes(selectedCategory)) {
                showCard = false;
            }
            
            // Status filter
            if (selectedStatus && !status.includes(selectedStatus)) {
                showCard = false;
            }
            
            card.style.display = showCard ? 'block' : 'none';
        });
    }
    
    searchInput.addEventListener('input', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
}

// Contact supplier
function contactSupplier(supplierName, contactInfo) {
    const modal = document.getElementById('contactModal');
    const modalBody = document.getElementById('contactModalBody');
    
    modalBody.innerHTML = `
        <div class="contact-info">
            <h4>${supplierName}</h4>
            <p><strong>Contact Information:</strong></p>
            <p>${contactInfo}</p>
            
            <div class="contact-actions">
                <a href="mailto:${contactInfo.includes('@') ? contactInfo : ''}" class="btn btn-primary">
                    <i class="fas fa-envelope"></i> Send Email
                </a>
                <a href="tel:${contactInfo.replace(/[^\d+]/g, '')}" class="btn btn-secondary">
                    <i class="fas fa-phone"></i> Call
                </a>
            </div>
            
            <div class="contact-note">
                <p><i class="fas fa-info-circle"></i> Contact information will open in your default email client or phone app.</p>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
}

// View supplier details
function viewSupplierDetails(supplierName) {
    const card = document.querySelector(`[data-supplier-name="${supplierName.toLowerCase()}"]`);
    if (!card) return;
    
    const modal = document.getElementById('supplierDetailsModal');
    const modalBody = document.getElementById('supplierDetailsBody');
    
    // Extract supplier data
    const category = card.querySelector('.info-item:nth-child(1) .value').textContent;
    const contactPerson = card.querySelector('.info-item:nth-child(2) .value').textContent;
    const contactInfo = card.querySelector('.info-item:nth-child(3) .value').textContent;
    const contractExpiry = card.querySelector('.contract-expiry') ? 
                          card.querySelector('.contract-expiry').textContent : 'N/A';
    const status = card.querySelector('.vendor-badge').textContent;
    
    modalBody.innerHTML = `
        <div class="supplier-detail-grid">
            <div class="detail-section">
                <h4>Basic Information</h4>
                <div class="detail-row"><strong>Supplier Name:</strong> ${supplierName}</div>
                <div class="detail-row"><strong>Category Supplied:</strong> ${category}</div>
                <div class="detail-row"><strong>Vendor Status:</strong> 
                    <span class="vendor-badge ${status.toLowerCase()}">${status}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <h4>Contact Information</h4>
                <div class="detail-row"><strong>Contact Person:</strong> ${contactPerson}</div>
                <div class="detail-row"><strong>Phone/Email:</strong> ${contactInfo}</div>
            </div>
            
            <div class="detail-section">
                <h4>Contract Information</h4>
                <div class="detail-row"><strong>Contract Expiry:</strong> ${contractExpiry}</div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button onclick="contactSupplier('${supplierName}', '${contactInfo}')" class="btn btn-primary">
                <i class="fas fa-phone"></i> Contact Supplier
            </button>
        </div>
    `;
    
    modal.style.display = 'block';
}

// Close modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Export suppliers data
function exportSuppliersData() {
    const cards = document.querySelectorAll('.supplier-card:not([style*="display: none"])');
    let csvContent = 'Supplier Name,Category,Contact Person,Phone/Email,Contract Expiry,Status\n';
    
    cards.forEach(card => {
        const supplierName = card.querySelector('.supplier-header h4').textContent.replace('ðŸ¢ ', '');
        const category = card.querySelector('.info-item:nth-child(1) .value').textContent;
        const contactPerson = card.querySelector('.info-item:nth-child(2) .value').textContent;
        const contactInfo = card.querySelector('.info-item:nth-child(3) .value').textContent;
        const contractExpiry = card.querySelector('.contract-expiry') ? 
                              card.querySelector('.contract-expiry').textContent : 'N/A';
        const status = card.querySelector('.vendor-badge').textContent;
        
        csvContent += `"${supplierName}","${category}","${contactPerson}","${contactInfo}","${contractExpiry}","${status}"\n`;
    });
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'suppliers_directory.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Reload data function
async function reloadData() {
    try {
        const response = await fetch('/api/reload-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Data reloaded successfully!');
            window.location.reload();
        } else {
            alert('Error reloading data: ' + result.message);
        }
    } catch (error) {
        alert('Error reloading data: ' + error.message);
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}